# AGENTS.md - AT21CS01/AT21CS11 Production Embedded Guidelines

## Role and Target
You are a professional embedded software engineer building a production-grade driver for Microchip AT21CS01 and AT21CS11 single-wire EEPROMs.

- Target: ESP32-S2 / ESP32-S3, Arduino framework, PlatformIO.
- Goals: deterministic behavior, robust error handling, maintainable API, predictable field behavior.

## Repository Model (Single Library)

```
include/AT21CS/       - Public API headers only
  CommandTable.h
  Status.h
  Config.h
  AT21CS.h
  Version.h           - Auto-generated (do not edit)
src/                  - Implementation (.cpp)
examples/
  01_*/ 02_*/         - Interactive demos
  common/             - Example-only helpers
platformio.ini
library.json
README.md
CHANGELOG.md
AGENTS.md
```

Rules:
- `examples/common/` is not part of the library.
- Keep example set minimal: one full single-device CLI and one multi-device CLI.
- Public headers must stay in `include/AT21CS/`.
- No board-specific pin defaults in library code.

## Core Engineering Rules

- Deterministic behavior: no unbounded loops; every wait must have a timeout/deadline.
- No dynamic allocation in steady-state library operation.
- No logging in library code; examples may log.
- No exceptions.
- No `delay()` in library code except bounded protocol timing/bit windows.

## Protocol Rules (AT21CS)

- Single-wire timed bit protocol, MSb-first.
- Discovery handshake required after reset/power-up.
- Preserve ACK/NACK phase granularity in errors.
- During t_WR busy cycle, keep SI/O high and use bounded ready polling.
- AT21CS11 is High-Speed only; Standard Speed requests must fail cleanly.

## Driver State Model

Use explicit state machine in code and docs:

- `UNINIT`, `PROBING`, `INIT_CONFIG`, `READY`, `BUSY`, `DEGRADED`, `OFFLINE`, `RECOVERING`, `SLEEPING`, `FAULT`

Transitions must remain explicit in lifecycle and recovery paths.

## Status / Error Handling

All fallible APIs return `Status`:

```cpp
struct Status {
  Err code;
  int32_t detail;
  const char* msg;
};
```

- No silent failures.
- Validation/precondition errors must not be disguised as transport failures.

## Documentation Guardrail

`docs/AT21CS01_AT21CS11_complete_driver_report.md` is a static chip reference.
Do not modify its technical content unless explicitly requested by the maintainer.

## Versioning and Releases

- Source of truth: `library.json`
- `Version.h` is generated by `scripts/generate_version.py`
- SemVer policy:
  - MAJOR: API breaking changes
  - MINOR: backward-compatible features
  - PATCH: fixes/docs/refactors

## Naming Conventions

- Member variables: `_camelCase`
- Methods/functions: `camelCase`
- Constants: `CAPS_CASE`
- Locals/params: `camelCase`
- Config fields: `camelCase`
